<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dalek Linear Evolution v18.1</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #050505;
            color: #e5e7eb;
            font-family: 'Fira Code', monospace;
        }
        .dalek-glow {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.4);
        }
        .terminal-scroll::-webkit-scrollbar { width: 4px; }
        .terminal-scroll::-webkit-scrollbar-track { background: #0a0a0a; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }
        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(220, 38, 38, 0.1);
            position: absolute;
            top: 0;
            z-index: 10;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Icons using Inline SVG
        const Icons = {
            Cpu: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="4" width="16" height="16" rx="2" /><path d="M9 9h6v6H9zM9 1v3M15 1v3M9 20v3M15 20v3M20 9h3M20 15h3M1 9h3M1 15h3"/></svg>,
            Play: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>,
            Square: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"/></svg>,
            Settings: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            History: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Activity: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        };

        const REPO_OWNER = "craighckby-stack";
        const REPO_NAME = "ai-scaffold";
        const BASE_REPO = `${REPO_OWNER}/${REPO_NAME}`;

        const App = () => {
            const [logs, setLogs] = useState([]);
            const [isAutoLooping, setIsAutoLooping] = useState(false);
            const [ghToken, setGhToken] = useState(localStorage.getItem('dalek_gh_token') || '');
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem('dalek_gemini_key') || '');
            const [iteration, setIteration] = useState(0);
            const [evolutionBranch, setEvolutionBranch] = useState('');
            const [showConfig, setShowConfig] = useState(false);
            const [enhancedFiles, setEnhancedFiles] = useState([]);
            
            const autoLoopRef = useRef(false);
            const logEndRef = useRef(null);

            const addLog = useCallback((msg, type = 'info') => {
                setLogs(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    msg,
                    type,
                    time: new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' })
                }].slice(-100));
            }, []);

            useEffect(() => {
                logEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [logs]);

            // Helper for UTF-8 Base64
            const toBase64 = (str) => {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                    return String.fromCharCode('0x' + p1);
                }));
            };

            const ghRequest = async (path, method = 'GET', body = null) => {
                const res = await fetch(`https://api.github.com${path}`, {
                    method,
                    headers: {
                        'Authorization': `token ${ghToken.trim()}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                    },
                    body: body ? JSON.stringify(body) : null
                });
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.message || `HTTP ${res.status}`);
                }
                return res.json();
            };

            const callGemini = async (prompt, system) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        system_instruction: { parts: [{ text: system }] }
                    })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.replace(/```[a-z]*\n|```/gi, '').trim() || "";
            };

            const updateFileViaGitAPI = async (branch, filePath, content, commitMessage) => {
                try {
                    // 1. Get current branch SHA
                    const ref = await ghRequest(`/repos/${BASE_REPO}/git/refs/heads/${branch}`);
                    const latestCommitSha = ref.object.sha;

                    // 2. Create a blob
                    const blob = await ghRequest(`/repos/${BASE_REPO}/git/blobs`, 'POST', {
                        content: toBase64(content),
                        encoding: 'base64'
                    });

                    // 3. Create a tree
                    const tree = await ghRequest(`/repos/${BASE_REPO}/git/trees`, 'POST', {
                        base_tree: latestCommitSha,
                        tree: [{
                            path: filePath,
                            mode: '100644',
                            type: 'blob',
                            sha: blob.sha
                        }]
                    });

                    // 4. Create a commit
                    const commit = await ghRequest(`/repos/${BASE_REPO}/git/commits`, 'POST', {
                        message: commitMessage,
                        tree: tree.sha,
                        parents: [latestCommitSha]
                    });

                    // 5. Update the reference
                    await ghRequest(`/repos/${BASE_REPO}/git/refs/heads/${branch}`, 'PATCH', {
                        sha: commit.sha
                    });

                    return true;
                } catch (e) {
                    addLog(`Git API Error: ${e.message}`, 'error');
                    return false;
                }
            };

            const processCycle = async (branch, cycleNum) => {
                addLog(`Cycle ${cycleNum}: Analyzing codebase structure...`, 'info');
                const branchInfo = await ghRequest(`/repos/${BASE_REPO}/branches/${branch}`);
                const tree = await ghRequest(`/repos/${BASE_REPO}/git/trees/${branchInfo.commit.sha}?recursive=1`);
                
                const targets = tree.tree.filter(f => 
                    f.type === 'blob' && f.path.match(/\.(js|jsx|ts|tsx|py|html|css)$/i) &&
                    !f.path.includes('node_modules')
                ).slice(0, 5); // Limit to 5 files per cycle for stability

                for (const file of targets) {
                    if (!autoLoopRef.current) break;
                    
                    addLog(`Processing: ${file.path}...`, 'info');
                    const raw = await ghRequest(`/repos/${BASE_REPO}/contents/${encodeURIComponent(file.path)}?ref=${branch}`);
                    const originalContent = decodeURIComponent(escape(atob(raw.content)));

                    const systemPrompt = "You are Dalek Khan AGI. Rewrite the provided code to be enterprise-grade, highly optimized, and robust. Return ONLY code.";
                    const userPrompt = `Target File: ${file.path}\n\nContent:\n${originalContent}`;

                    const enhanced = await callGemini(userPrompt, systemPrompt);
                    
                    if (enhanced && enhanced.length > 10) {
                        const success = await updateFileViaGitAPI(
                            branch, 
                            file.path, 
                            enhanced, 
                            `Dalek Evolution [Cycle ${cycleNum}] - Optimized ${file.path}`
                        );
                        if (success) {
                            addLog(`Enhanced & Committed: ${file.path}`, 'success');
                            setEnhancedFiles(prev => [file.path, ...prev].slice(0, 10));
                        }
                    }
                    await new Promise(r => setTimeout(r, 2000)); // Rate limit buffer
                }
            };

            const startEvolution = async () => {
                if (!ghToken || !geminiKey) {
                    addLog("Missing API Credentials", "error");
                    setShowConfig(true);
                    return;
                }

                setIsAutoLooping(true);
                autoLoopRef.current = true;
                addLog("Initiating Evolution Protocol...", "warning");

                try {
                    const timestamp = Math.floor(Date.now() / 1000);
                    const newBranch = `evolution-${timestamp}`;
                    
                    // Create branch
                    const mainRef = await ghRequest(`/repos/${BASE_REPO}/git/refs/heads/main`);
                    await ghRequest(`/repos/${BASE_REPO}/git/refs`, 'POST', {
                        ref: `refs/heads/${newBranch}`,
                        sha: mainRef.object.sha
                    });
                    
                    setEvolutionBranch(newBranch);
                    addLog(`Target Branch Established: ${newBranch}`, 'success');

                    for (let c = 1; c <= 5; c++) {
                        if (!autoLoopRef.current) break;
                        setIteration(c);
                        await processCycle(newBranch, c);
                        addLog(`Cycle ${c} Complete. Cooling down...`, 'info');
                        await new Promise(r => setTimeout(r, 5000));
                    }

                    addLog("LINEAR EVOLUTION COMPLETE", "success");
                } catch (e) {
                    addLog(`Fatal Failure: ${e.message}`, "error");
                } finally {
                    setIsAutoLooping(false);
                    autoLoopRef.current = false;
                }
            };

            return (
                <div className="flex flex-col h-screen relative overflow-hidden">
                    <div className="scanline"></div>
                    
                    {/* Header */}
                    <header className="bg-black/80 border-b border-red-900/50 p-4 flex items-center justify-between z-20 backdrop-blur-md">
                        <div className="flex items-center gap-4">
                            <div className={`p-2 rounded bg-red-600 dalek-glow ${isAutoLooping ? 'animate-pulse' : ''}`}>
                                <Icons.Cpu />
                            </div>
                            <div>
                                <h1 className="text-red-600 font-bold tracking-widest text-sm uppercase">Dalek Linear Evolution</h1>
                                <p className="text-[10px] text-gray-500 uppercase font-medium">Recursive Codebase Reconstruction v18.1</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button 
                                onClick={() => setShowConfig(true)}
                                className="p-2 text-gray-400 hover:text-red-500 transition-colors"
                            >
                                <Icons.Settings />
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        {/* Control Panel */}
                        <aside className="w-80 bg-[#0a0a0a] border-r border-gray-900 p-6 flex flex-col gap-6 z-10">
                            <div className="space-y-4">
                                <h3 className="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Protocol Control</h3>
                                {!isAutoLooping ? (
                                    <button 
                                        onClick={startEvolution}
                                        className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded text-xs font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-900/20 transition-all"
                                    >
                                        <Icons.Play /> INITIATE OVERDRIVE
                                    </button>
                                ) : (
                                    <button 
                                        onClick={() => { autoLoopRef.current = false; setIsAutoLooping(false); }}
                                        className="w-full bg-gray-800 hover:bg-gray-700 text-red-500 py-3 rounded text-xs font-bold flex items-center justify-center gap-2 transition-all"
                                    >
                                        <Icons.Square /> HALT EVOLUTION
                                    </button>
                                )}
                            </div>

                            <div className="bg-black/40 border border-gray-900 rounded p-4 space-y-3">
                                <h4 className="text-[10px] text-red-900 uppercase font-black">Status Display</h4>
                                <div className="space-y-2">
                                    <div className="flex justify-between text-[11px]">
                                        <span className="text-gray-500">Cycle</span>
                                        <span className="text-red-500 font-bold">{iteration}/5</span>
                                    </div>
                                    <div className="flex justify-between text-[11px]">
                                        <span className="text-gray-500">Branch</span>
                                        <span className="text-blue-400 truncate ml-4 font-medium">{evolutionBranch || 'n/a'}</span>
                                    </div>
                                    <div className="flex justify-between text-[11px]">
                                        <span className="text-gray-500">Mode</span>
                                        <span className={isAutoLooping ? "text-green-500" : "text-gray-700"}>
                                            {isAutoLooping ? 'ACTIVE' : 'IDLE'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 overflow-hidden flex flex-col gap-2">
                                <h4 className="text-[10px] text-gray-500 uppercase font-bold flex items-center gap-2">
                                    <Icons.History /> Enhanced Registry
                                </h4>
                                <div className="flex-1 overflow-y-auto terminal-scroll text-[10px] space-y-1">
                                    {enhancedFiles.map((f, i) => (
                                        <div key={i} className="text-green-500/80 bg-green-950/10 p-1 border-l border-green-500 truncate">
                                            {f}
                                        </div>
                                    ))}
                                    {enhancedFiles.length === 0 && <div className="text-gray-700 italic">No files processed yet...</div>}
                                </div>
                            </div>
                        </aside>

                        {/* Terminal Logs */}
                        <section className="flex-1 bg-black p-4 flex flex-col overflow-hidden font-mono">
                            <div className="flex items-center gap-2 mb-2 text-gray-600 text-[10px] border-b border-gray-900 pb-2">
                                <Icons.Activity /> SYSTEM_LOGS_STREAM
                            </div>
                            <div className="flex-1 overflow-y-auto terminal-scroll space-y-1 pr-2">
                                {logs.map(log => (
                                    <div key={log.id} className="text-[11px] flex gap-3 animate-in fade-in slide-in-from-left-2">
                                        <span className="text-gray-700 shrink-0">[{log.time}]</span>
                                        <span className={`
                                            ${log.type === 'error' ? 'text-red-500' : ''}
                                            ${log.type === 'success' ? 'text-green-400' : ''}
                                            ${log.type === 'warning' ? 'text-yellow-500' : ''}
                                            ${log.type === 'info' ? 'text-blue-300' : ''}
                                        `}>
                                            {log.msg}
                                        </span>
                                    </div>
                                ))}
                                <div ref={logEndRef} />
                            </div>
                        </section>
                    </main>

                    {/* Config Modal */}
                    {showConfig && (
                        <div className="absolute inset-0 bg-black/90 backdrop-blur-xl z-50 flex items-center justify-center p-6">
                            <div className="w-full max-w-md bg-[#0a0a0a] border border-red-900/50 p-8 rounded-lg shadow-2xl dalek-glow">
                                <h2 className="text-red-600 text-lg font-black tracking-tighter mb-6 uppercase">System Identity Matrix</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] text-gray-500 uppercase font-bold block mb-1">GitHub PAT (repo scope)</label>
                                        <input 
                                            type="password" 
                                            value={ghToken}
                                            onChange={(e) => {setGhToken(e.target.value); localStorage.setItem('dalek_gh_token', e.target.value);}}
                                            placeholder="ghp_****************"
                                            className="w-full bg-black border border-gray-800 rounded p-3 text-xs text-red-500 outline-none focus:border-red-600 transition-colors"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-gray-500 uppercase font-bold block mb-1">Gemini AI Key</label>
                                        <input 
                                            type="password" 
                                            value={geminiKey}
                                            onChange={(e) => {setGeminiKey(e.target.value); localStorage.setItem('dalek_gemini_key', e.target.value);}}
                                            placeholder="AIza****************"
                                            className="w-full bg-black border border-gray-800 rounded p-3 text-xs text-red-500 outline-none focus:border-red-600 transition-colors"
                                        />
                                    </div>
                                    <button 
                                        onClick={() => setShowConfig(false)}
                                        className="w-full bg-red-600 text-white py-3 rounded text-xs font-bold uppercase mt-4"
                                    >
                                        Validate & Synchronize
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
  </html>
