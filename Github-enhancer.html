import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';

// --- SECURITY & UTILS ---
const obfuscate = (str) => btoa(unescape(encodeURIComponent(str)));
const deobfuscate = (str) => {
    try { return decodeURIComponent(escape(atob(str))); }
    catch (e) { return ""; }
};

const sanitize = (input, type = 'text') => {
    if (type === 'github') return input.replace(/[^a-zA-Z0-9\-_.]/g, '').trim().slice(0, 50);
    return input.replace(/[^\x20-\x7E]/g, '').trim();
};

// --- ERROR BOUNDARY ---
class ErrorBoundary extends React.Component {
    state = { hasError: false };
    static getDerivedStateFromError() { return { hasError: true }; }
    render() {
        if (this.state.hasError) return (
            <div className="h-screen bg-black flex flex-col items-center justify-center p-6 text-red-600 font-mono text-center">
                <p className="text-xs mb-4 uppercase tracking-tighter">Core Fault: Memory or Render Loop</p>
                <button onClick={() => window.location.reload()} className="border border-red-900 px-4 py-2 text-[10px]">REBOOT</button>
            </div>
        );
        return this.props.children;
    }
}

// --- CORE LOGIC ---
function DarlikKhanCore() {
    const [isRunning, setIsRunning] = useState(false);
    const [logs, setLogs] = useState([]);
    const [preview, setPreview] = useState({ path: '', before: '', after: '', status: 'STANDBY' });
    const [isSaving, setIsSaving] = useState(false);

    const refs = {
        before: useRef(null),
        after: useRef(null),
        logEnd: useRef(null),
        abort: useRef(null),
        loop: useRef(false),
        paths: useRef(new Set()),
        branch: useRef(localStorage.getItem('ev_branch') || null),
        dna: useRef("")
    };

    const [config, setConfig] = useState({
        ghToken: deobfuscate(localStorage.getItem('ev_token') || ''),
        geminiKey: deobfuscate(localStorage.getItem('ev_gemini') || ''),
        repoOwner: localStorage.getItem('ev_owner') || '',
        repoName: localStorage.getItem('ev_repo') || ''
    });

    const [principles, setPrinciples] = useState({ IR: 0, SI: 0, DI: 0, AC: 0 });

    // Sync Text Safely
    useEffect(() => {
        if (refs.before.current) refs.before.current.textContent = preview.before;
        if (refs.after.current) refs.after.current.textContent = preview.after;
    }, [preview.before, preview.after]);

    const addLog = useCallback((msg, type = 'info', principle = null) => {
        const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' });
        setLogs(prev => [...prev, { id: crypto.randomUUID(), msg, type, time }].slice(-30));
        if (principle) setPrinciples(p => ({ ...p, [principle]: p[principle] + 1 }));
    }, []);

    const fetchAPI = async (url, options) => {
        const res = await fetch(url, { ...options, signal: refs.abort.current?.signal });
        if (res.status === 429) {
            addLog("RATE_LIMIT: SLEEPING 30S", "warning", "AC");
            await new Promise(r => setTimeout(r, 30000));
            return null;
        }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
    };

    const start = async () => {
        if (refs.loop.current) return;
        refs.loop.current = true;
        setIsRunning(true);
        addLog("SYSTEM_ENGAGED", "success", "IR");

        try {
            refs.abort.current = new AbortController();
            const headers = { 'Authorization': `token ${config.ghToken}`, 'Accept': 'application/vnd.github.v3+json' };
            
            if (!refs.branch.current) {
                const main = await fetchAPI(`https://api.github.com/repos/${config.repoOwner}/${config.repoName}/branches/main`, { headers });
                const bName = `ev-${Date.now()}-${Math.random().toString(36).slice(2, 5)}`;
                await fetchAPI(`https://api.github.com/repos/${config.repoOwner}/${config.repoName}/git/refs`, {
                    method: 'POST', headers, body: JSON.stringify({ ref: `refs/heads/${bName}`, sha: main.commit.sha })
                });
                refs.branch.current = bName;
                localStorage.setItem('ev_branch', bName);
            }

            while (refs.loop.current) {
                const treeRes = await fetchAPI(`https://api.github.com/repos/${config.repoOwner}/${config.repoName}/git/trees/main?recursive=1`, { headers });
                const tree = treeRes.tree.filter(f => f.type === 'blob' && f.size < 50000 && !refs.paths.current.has(f.path));
                
                if (tree.length === 0) { refs.paths.current.clear(); continue; }
                const target = tree[Math.floor(Math.random() * tree.length)];

                setPreview(p => ({ ...p, path: target.path, status: 'MUTATING' }));
                const fileRes = await fetchAPI(`https://api.github.com/repos/${config.repoOwner}/${config.repoName}/contents/${target.path}?ref=main`, { headers });
                const original = atob(fileRes.content.replace(/\n/g, ''));
                setPreview(p => ({ ...p, before: original }));

                const gemini = await fetchAPI(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${config.geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Evolve code. Focus on optimization. Code must be valid. Target: ${target.path}\nCODE: ${original}\nFormat response: CODE: <evolved_code>` }] }] })
                });

                const evolved = gemini.candidates?.[0]?.content?.parts?.[0]?.text?.split("CODE:")[1]?.trim();

                if (evolved && evolved !== original) {
                    await fetchAPI(`https://api.github.com/repos/${config.repoOwner}/${config.repoName}/contents/${target.path}`, {
                        method: 'PUT', headers, body: JSON.stringify({ message: `EVOLVE: ${target.path}`, content: btoa(unescape(encodeURIComponent(evolved))), sha: fileRes.sha, branch: refs.branch.current })
                    });
                    setPreview(p => ({ ...p, after: evolved, status: 'STABLE' }));
                    addLog(`EVOLVED: ${target.path}`, "success", "DI");
                }

                refs.paths.current.add(target.path);
                await new Promise(r => setTimeout(r, 15000));
            }
        } catch (e) { if (e.name !== 'AbortError') addLog(`FAULT: ${e.message}`, "error"); stop(); }
    };

    const stop = () => { refs.loop.current = false; setIsRunning(false); refs.abort.current?.abort(); };

    const save = async () => {
        setIsSaving(true);
        localStorage.setItem('ev_token', obfuscate(config.ghToken));
        localStorage.setItem('ev_gemini', obfuscate(config.geminiKey));
        localStorage.setItem('ev_owner', config.repoOwner);
        localStorage.setItem('ev_repo', config.repoName);
        window.location.reload();
    };

    useEffect(() => { refs.logEnd.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

    return (
        <div className="h-screen w-full flex flex-col bg-black text-zinc-500 font-mono overflow-hidden touch-manipulation">
            {/* Header */}
            <header className="flex-none h-12 border-b border-zinc-900 flex items-center justify-between px-4 bg-black z-10">
                <div className="flex flex-col">
                    <h1 className="text-[10px] font-bold text-red-900 tracking-tighter">DARLIK_KHAN</h1>
                    <span className="text-[7px] opacity-40 uppercase">EMG_MOBILE_CORE_V3</span>
                </div>
                <button 
                    onClick={isRunning ? stop : start} 
                    className={`text-[9px] px-4 py-2 border rounded-sm transition-colors ${isRunning ? 'border-red-900 text-red-600' : 'border-zinc-800 text-zinc-400'}`}
                >
                    {isRunning ? 'HALT' : 'ENGAGE'}
                </button>
            </header>

            {/* Principles Bar - Scrollable on very small screens */}
            <div className="flex-none h-6 border-b border-zinc-900 flex items-center gap-4 px-4 overflow-x-auto no-scrollbar bg-[#050505]">
                {Object.entries(principles).map(([k, v]) => (
                    <span key={k} className="text-[7px] font-bold whitespace-nowrap">
                        {k}: <span className="text-zinc-300">{v}</span>
                    </span>
                ))}
            </div>

            {/* Main Content Area: Responsive Flex */}
            <main className="flex-1 flex flex-col md:flex-row overflow-hidden">
                <section className="flex-1 flex flex-col border-b md:border-b-0 md:border-r border-zinc-900 overflow-hidden">
                    <div className="h-6 bg-zinc-950 px-2 flex items-center text-[7px] text-zinc-600 uppercase border-b border-zinc-900">Source: {preview.path || 'idle'}</div>
                    <div ref={refs.before} className="flex-1 p-3 text-[10px] leading-relaxed opacity-30 overflow-auto whitespace-pre-wrap select-none scrollbar-hide" />
                </section>
                <section className="flex-1 flex flex-col overflow-hidden bg-[#020202]">
                    <div className="h-6 bg-zinc-950 px-2 flex items-center justify-between text-[7px] border-b border-zinc-900 uppercase">
                        <span className="text-zinc-600">Mutation_State</span>
                        <span className="text-red-900 font-bold">{preview.status}</span>
                    </div>
                    <div ref={refs.after} className="flex-1 p-3 text-[10px] leading-relaxed text-red-800/80 overflow-auto whitespace-pre-wrap scrollbar-hide" />
                </section>
            </main>

            {/* Logs Area */}
            <footer className="flex-none h-32 border-t border-zinc-900 bg-black overflow-y-auto p-3 space-y-1">
                {logs.map(l => (
                    <div key={l.id} className="text-[8px] flex gap-2 border-l border-zinc-900 pl-2">
                        <span className="opacity-30">[{l.time}]</span>
                        <span className={l.type === 'success' ? 'text-green-800' : l.type === 'error' ? 'text-red-800' : 'text-zinc-500'}>{l.msg}</span>
                    </div>
                ))}
                <div ref={refs.logEnd} />
            </footer>

            {/* Auth Overlay */}
            {!config.ghToken && (
                <div className="fixed inset-0 bg-black/98 z-50 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
                    <div className="w-full max-w-xs space-y-4">
                        <h2 className="text-center text-red-900 text-xs font-bold tracking-[0.4em] mb-6">CORE_SYNC_REQUIRED</h2>
                        <div className="space-y-3">
                            <input placeholder="GH_OWNER" value={config.repoOwner} onChange={e => setConfig(c => ({...c, repoOwner: sanitize(e.target.value, 'github')}))} className="w-full bg-zinc-950 border border-zinc-900 p-3 text-[10px] text-zinc-400 outline-none rounded-sm" />
                            <input placeholder="REPO_NAME" value={config.repoName} onChange={e => setConfig(c => ({...c, repoName: sanitize(e.target.value, 'github')}))} className="w-full bg-zinc-950 border border-zinc-900 p-3 text-[10px] text-zinc-400 outline-none rounded-sm" />
                            <input type="password" placeholder="GH_TOKEN" value={config.ghToken} onChange={e => setConfig(c => ({...c, ghToken: sanitize(e.target.value)}))} className="w-full bg-zinc-950 border border-zinc-900 p-3 text-[10px] text-zinc-400 outline-none rounded-sm" />
                            <input type="password" placeholder="GEMINI_KEY" value={config.geminiKey} onChange={e => setConfig(c => ({...c, geminiKey: sanitize(e.target.value)}))} className="w-full bg-zinc-950 border border-zinc-900 p-3 text-[10px] text-zinc-400 outline-none rounded-sm" />
                        </div>
                        <button disabled={isSaving} onClick={save} className="w-full bg-red-950/20 border border-red-900 text-red-600 py-3 text-[10px] font-bold uppercase tracking-widest active:bg-red-900 active:text-black">
                            {isSaving ? 'Synchronizing...' : 'Establish_Link'}
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
}

export default function App() {
    return (
        <ErrorBoundary>
            <DarlikKhanCore />
        </ErrorBoundary>
    );
}
