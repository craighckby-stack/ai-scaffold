<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dalek Linear Evolution - Recursive Commits v18</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Courier New', monospace; }
    .custom-scroll::-webkit-scrollbar { width: 2px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #330000; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { ShieldAlert, History, Play, Square, X } = lucideReact;

    const REPO_OWNER = "craighckby-stack";
    const REPO_NAME = "ai-scaffold";
    const BASE_REPO = `${REPO_OWNER}/${REPO_NAME}`;

    const App = () => {
      const [user, setUser] = useState(null);
      const [logs, setLogs] = useState([]);
      const [isRunning, setIsRunning] = useState(false);
      const [isAutoLooping, setIsAutoLooping] = useState(false);
      const [remainingCycles, setRemainingCycles] = useState(0);
      const [ghToken, setGhToken] = useState('');
      const [vaultData, setVaultData] = useState([]);
      const [currentStep, setCurrentStep] = useState(0);
      const [evolutionBranch, setEvolutionBranch] = useState('');
      const [iteration, setIteration] = useState(0);
      const [showVault, setShowVault] = useState(false);
      
      const autoLoopRef = useRef(false);
      const logEndRef = useRef(null);

      useEffect(() => {
        // Initialize Firebase (configure with your own config)
        if (typeof firebase !== 'undefined') {
          try {
            firebase.initializeApp({
              apiKey: "YOUR_FIREBASE_API_KEY",
              authDomain: "YOUR_PROJECT.firebaseapp.com",
              projectId: "YOUR_PROJECT_ID"
            });
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // Anonymous sign in
            auth.signInAnonymously().catch(console.error);
            
            auth.onAuthStateChanged(setUser);
            
            // Listen to vault data
            if (db) {
              db.collection('artifacts')
                .doc('dalek-khan-v18')
                .collection('public')
                .doc('data')
                .collection('linear_evolution')
                .orderBy('timestamp', 'desc')
                .limit(15)
                .onSnapshot(s => {
                  setVaultData(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });
            }
          } catch (e) {
            console.log('Firebase not configured, running without persistence');
          }
        }
      }, []);

      useEffect(() => {
        logEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [logs]);

      const addLog = (msg, type = 'info') => {
        setLogs(prev => [...prev, { id: crypto.randomUUID(), msg, type, time: new Date().toLocaleTimeString() }].slice(-100));
      };

      const gh = async (path, method = 'GET', body = null) => {
        const res = await fetch(`https://api.github.com${path}`, {
          method,
          headers: {
            'Authorization': `token ${ghToken.trim()}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: body ? JSON.stringify(body) : null
        });
        if (!res.ok) {
          const err = await res.text();
          throw new Error(`GH_${res.status}: ${err}`);
        }
        const text = await res.text();
        return text ? JSON.parse(text) : null;
      };

      const callGemini = async (prompt, system) => {
        const apiKey = prompt("Enter your Gemini API Key:");
        if (!apiKey) throw new Error("API Key required");
        
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: system }] }
          })
        });
        const data = await res.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      };

      const startLinearOverdrive = async () => {
        if (isAutoLooping || !ghToken) return;
        setIsAutoLooping(true);
        autoLoopRef.current = true;
        addLog("INITIATING LINEAR EVOLUTION...", "warning");

        try {
          // 1. Create a SINGLE branch for the entire process
          const baseRef = await gh(`/repos/${BASE_REPO}/git/refs/heads/main`);
          const branchName = `linear-evolution-${Date.now().toString().slice(-4)}`;
          await gh(`/repos/${BASE_REPO}/git/refs`, 'POST', {
            ref: `refs/heads/${branchName}`,
            sha: baseRef.object.sha
          });
          setEvolutionBranch(branchName);
          addLog(`TIMELINE ESTABLISHED: ${branchName}`, "success");

          // 2. Start cycle loop
          const totalCycles = 5; // Reduced for demo
          for (let i = 0; i < totalCycles; i++) {
            if (!autoLoopRef.current) break;
            setRemainingCycles(totalCycles - i);
            setIsRunning(true);
            setIteration(i + 1);

            addLog(`CYCLE ${i + 1}/${totalCycles}: SCANNING CURRENT STATE...`, "info");
            setCurrentStep(2);
            
            // Fetch current file tree
            const tree = await gh(`/repos/${BASE_REPO}/git/trees/${branchName}?recursive=1`);
            const files = tree.tree.filter(f => f.type === 'blob' && f.path.match(/\.(js|jsx|ts|tsx|py|md|css|html|json)$/)).slice(0, 10);
            
            let context = "CURRENT CODEBASE:\n";
            for (const f of files) {
              try {
                const content = await gh(`/repos/${BASE_REPO}/contents/${f.path}?ref=${branchName}`);
                if (content?.content) {
                  context += `\nFILE: ${f.path}\nSOURCE:\n${atob(content.content.replace(/\n/g, ''))}\n---\n`;
                }
              } catch(e) {}
            }

            setCurrentStep(3);
            addLog(`CYCLE ${i + 1}: RE-ENGINEERING SYSTEM...`, "info");
            
            const result = await callGemini(
              `${context}\n\nENHANCE EVERYTHING. FIX BUGS. OPTIMIZE ARCHITECTURE.`,
              `You are Dalek Khan AGI. Rewrite system for perfection.
              Response format: @@@FILE_PATH: [path]\n[ENHANCED_CODE]\n@@@END_FILE`
            );

            const fileBlocks = result.split('@@@FILE_PATH:').filter(b => b.trim().length > 0);
            let commitCount = 0;
            
            for (const block of fileBlocks) {
              const parts = block.split('@@@END_FILE');
              const lines = parts[0].trim().split('\n');
              const path = lines[0].trim();
              const content = lines.slice(1).join('\n').trim();

              if (path && content) {
                try {
                  const existing = await gh(`/repos/${BASE_REPO}/contents/${path}?ref=${branchName}`).catch(() => null);
                  await gh(`/repos/${BASE_REPO}/contents/${path}`, 'PUT', {
                    message: `Linear Evolution Cycle ${i + 1} | Refinement of ${path}`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: branchName,
                    sha: existing?.sha
                  });
                  commitCount++;
                } catch (e) {
                  addLog(`Commit failed for ${path}: ${e.message}`, "error");
                }
              }
            }

            addLog(`CYCLE ${i + 1} COMPLETE: Refined ${commitCount} modules`, "success");
            setIsRunning(false);
            await new Promise(r => setTimeout(r, 2000));
          }
          
          addLog("EVOLUTION CYCLES COMPLETE", "success");
        } catch (err) {
          addLog(`EVOLUTION HALTED: ${err.message}`, "error");
        } finally {
          setIsAutoLooping(false);
          autoLoopRef.current = false;
          setIsRunning(false);
          setRemainingCycles(0);
          setCurrentStep(0);
        }
      };

      const stopOverdrive = () => {
        autoLoopRef.current = false;
        setIsAutoLooping(false);
        addLog("MANUAL ABORT REQUESTED", "error");
      };

      const ShieldAlertIcon = ShieldAlert || (() => <span>‚ö†Ô∏è</span>);
      const HistoryIcon = History || (() => <span>üìú</span>);
      const PlayIcon = Play || (() => <span>‚ñ∂Ô∏è</span>);
      const SquareIcon = Square || (() => <span>‚èπÔ∏è</span>);
      const XIcon = X || (() => <span>‚úï</span>);

      return (
        <div className="flex flex-col h-screen bg-black text-zinc-400 font-mono overflow-hidden">
          {/* Header */}
          <header className="flex-none bg-zinc-950 border-b border-red-900/40 p-4">
            <div style={{ maxWidth: '1280px', margin: '0 auto', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <div style={{ padding: '8px', borderRadius: '4px', backgroundColor: isAutoLooping ? '#dc2626' : '#7f1d1d' }}>
                  <ShieldAlertIcon size={20} style={{ color: 'black' }} />
                </div>
                <div>
                  <h1 style={{ fontSize: '12px', fontWeight: '900', letterSpacing: '0.2em', color: '#dc2626', textTransform: 'uppercase' }}>Dalek Linear Evolution</h1>
                  <p style={{ fontSize: '8px', color: '#52525b', textTransform: 'uppercase', fontWeight: 'bold' }}>Recursive Commits v18</p>
                </div>
              </div>
              <button onClick={() => setShowVault(!showVault)} style={{ padding: '8px', color: '#71717a', backgroundColor: 'transparent', border: 'none', cursor: 'pointer' }}>
                {showVault ? <XIcon size={20} /> : <HistoryIcon size={20} />}
              </button>
            </div>
          </header>

          {/* Controls */}
          <div style={{ flex: 'none', backgroundColor: 'rgba(24, 24, 27, 0.5)', borderBottom: '1px solid #27272a', padding: '16px' }}>
            <div style={{ maxWidth: '1280px', margin: '0 auto', display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <input 
                type="password" 
                placeholder="GITHUB_TOKEN" 
                style={{ width: '100%', backgroundColor: 'black', border: '1px solid #27272a', color: '#ef4444', fontSize: '10px', padding: '12px', borderRadius: '4px', outline: 'none', fontFamily: 'Courier New, monospace' }}
                value={ghToken}
                onChange={e => setGhToken(e.target.value)}
              />
              {!isAutoLooping ? (
                <button 
                  onClick={startLinearOverdrive}
                  disabled={!ghToken}
                  style={{ width: '100%', backgroundColor: '#b91c1c', color: 'white', padding: '12px', borderRadius: '4px', fontSize: '10px', fontWeight: '900', textTransform: 'uppercase', border: 'none', cursor: ghToken ? 'pointer' : 'not-allowed', opacity: ghToken ? 1 : 0.5, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}
                >
                  <PlayIcon size={14} fill="white" /> Initiate 5-Cycle Evolution
                </button>
              ) : (
                <button 
                  onClick={stopOverdrive}
                  style={{ width: '100%', backgroundColor: '#27272a', color: '#ef4444', padding: '12px', borderRadius: '4px', fontSize: '10px', fontWeight: '900', textTransform: 'uppercase', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}
                >
                  <SquareIcon size={14} fill="red" /> Stop Evolution
                </button>
              )}
            </div>
          </div>

          {/* Workspace */}
          <main style={{ flex: 1, display: 'flex', flexDirection: 'column', position: 'relative', overflow: 'hidden', backgroundColor: '#050505' }}>
            <div style={{ flex: 'none', display: 'grid', gridTemplateColumns: '1fr 1fr', backgroundColor: '#18181b', gap: '1px', borderBottom: '1px solid #18181b' }}>
               <div style={{ backgroundColor: 'black', padding: '12px' }}>
                  <span style={{ fontSize: '8px', color: '#52525b', textTransform: 'uppercase', display: 'block' }}>Active Branch</span>
                  <span style={{ fontSize: '10px', color: '#10b981', fontWeight: 'bold', display: 'block', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{evolutionBranch || 'awaiting...'}</span>
               </div>
               <div style={{ backgroundColor: 'black', padding: '12px' }}>
                  <span style={{ fontSize: '8px', color: '#52525b', textTransform: 'uppercase', display: 'block' }}>Refinement Cycle</span>
                  <span style={{ fontSize: '10px', color: '#ef4444', fontWeight: 'bold', display: 'block' }}>{iteration} / 5</span>
               </div>
            </div>

            <div style={{ flex: 1, overflowY: 'auto', padding: '16px', display: 'flex', flexDirection: 'column', gap: '8px' }} className="custom-scroll">
              {logs.map(l => (
                <div key={l.id} style={{ fontSize: '10px', fontFamily: 'Courier New, monospace', animation: 'fadeIn 0.3s ease-in' }}>
                  <span style={{ color: '#27272a', marginRight: '8px' }}>[{l.time}]</span>
                  <span style={{ color: l.type === 'error' ? '#ef4444' : l.type === 'success' ? '#10b981' : l.type === 'warning' ? '#f59e0b' : '#71717a' }}>
                    {l.msg}
                  </span>
                </div>
              ))}
              <div ref={logEndRef} />
            </div>

            {/* Slide-over Vault */}
            <div style={{ position: 'absolute', inset: 0, backgroundColor: 'black', zIndex: 50, transition: 'transform 0.3s', transform: showVault ? 'translateX(0)' : 'translateX(100%)', display: 'flex', flexDirection: 'column' }}>
              <div style={{ padding: '16px', borderBottom: '1px solid #27272a', display: 'flex', justifyContent: 'space-between', alignItems: 'center', backgroundColor: '#09090b' }}>
                <span style={{ fontSize: '12px', fontWeight: '900', textTransform: 'uppercase', color: '#dc2626' }}>Evolution History</span>
                <button onClick={() => setShowVault(false)} style={{ color: '#71717a', backgroundColor: 'transparent', border: 'none', cursor: 'pointer' }}><XIcon size={20}/></button>
              </div>
              <div style={{ flex: 1, overflowY: 'auto', padding: '16px', display: 'flex', flexDirection: 'column', gap: '12px' }} className="custom-scroll">
                {vaultData.map(v => (
                  <div key={v.id} style={{ padding: '12px', backgroundColor: 'rgba(24, 24, 27, 0.5)', border: '1px solid #27272a', borderRadius: '4px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '9px', marginBottom: '4px' }}>
                      <span style={{ color: '#991b1b', fontWeight: 'bold' }}>CYCLE {v.cycle}</span>
                      <span style={{ color: '#52525b' }}>{v.timestamp ? new Date(v.timestamp.seconds * 1000).toLocaleTimeString() : ''}</span>
                    </div>
                    <p style={{ fontSize: '10px', color: '#a1a1aa', fontStyle: 'italic' }}>{v.meta}</p>
                  </div>
                ))}
                {vaultData.length === 0 && (
                  <p style={{ fontSize: '10px', color: '#52525b', textAlign: 'center', padding: '20px' }}>
                    No evolution history available. Firebase not configured.
                  </p>
                )}
              </div>
            </div>
          </main>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
